#  Malware Analysis

## Task 1: Set up your environment

1. Prepare and secure malware analysis environment for example FLARE VM. Make sure that VM uses a HOST ONLY network adapter.
2. Use any virtualization environment, better to use the latest version (check repo and official website).
3. Or you can create a Virtual Machine and set it up as a malware analysis environmen


### Implementation:

For this puprose, I create a "Windows" VM using virtualbox. Then I download the FLARE VM script and let it update and download all its requirments.


    
![](https://i.imgur.com/eQqZ8nu.png)

![](https://i.imgur.com/WAbvTrH.png)

![](https://i.imgur.com/MeSf51D.png)


![](https://i.imgur.com/IkoHETh.png)



After that, I changed the VM's settings to host only:



![](https://i.imgur.com/XD1UZMu.png)



## Task 2: Letâ€™s get some malware

1. Download some malware/ransomware from the Internet (for example, TheZoo repo). Please be careful when you run them, THESE ARE REAL MALWARE.
2. Select at least two malware that you want to analyze in a malware analysis environment.


### Implementation:

For this analysis, I downloaded "locky ransomware".


## Task 3: Static Analysis

1. Use any tool for static analysis of your selected malware (for example, Ghidra, IDA, Binary Ninja, Hopper, Radare2, ...).




### Implementation:

First of all I tried to use this application to see if the given malware is packed or not:



![](https://i.imgur.com/wFpZVwu.png)



As you can see it says no, it is not packed malware.
But lets try another tool too:



![](https://i.imgur.com/v8cv53P.png)    
    


It also says that there is nothing there.

The next tool is for calculating the hash of the file and using the hash to search it in virustotal.



![](https://i.imgur.com/GaLVxu1.png)



The other useful application that I found is "Pestudio":



![](https://i.imgur.com/8CDptr1.png)

![](https://i.imgur.com/F8tIuV9.png)
    


We can see the functions that were called in this malware and this tool considered as malicious. Also in the library part, we can see that for example "wininet" is used that make us think this malware is going to start a communication. I will go deeply inside all of the information.


I tried to use "Ghidra" to look through the disassembly of this malware.

In the "entry" poibt, it will do some initializations i.e for heap and etc.



![](https://i.imgur.com/qhgfRkS.png)



After all of them, there was a fucntion that was called. Inside it, the most important part that I saw was : 



![](https://i.imgur.com/BMTQ2KR.png)



First it would load the "kernel32" library. kernel32.dll runs as part of the kernel module. It is one of the files required for the proper functioning of the Windows OS.

The other interesting part was the IP addresses. I guess it will use them to create a http connection (I also saw the "HTTP, POST" strings inside this malware).

Then it would pass this list to a function.


The other part of this currect function is that it is reading the system language. As far as I read, this ransomware would show its message based on the system's language. So, thats why it is reading the user's information.

Also it is reading and writing in to the registers.



![](https://i.imgur.com/3t85Cu8.png)



Going down we can see a harmful action:



![](https://i.imgur.com/qrm7AkG.png)



When I searched this command this was what I found:
> There are a few methods that the ransomware malware developers use to delete the Shadow Volume Copies, but the most prevalent one is to use the vssadmin.exe Delete Shadows /All /Quiet command. This command will execute the vssadmin.exe utility and have it quietly delete all of the Shadow Volume Copies on the computer.

In this way, the victim has no other choice, all the files will be encrypted and no backup left.

For the next step, I went through "wininet.dll" functions (based on maliciously considered from "pestudio"):



![](https://i.imgur.com/kOIl66B.png)



There was a function that fully used this functions. First of all it would check the url (I guess it ment to be URL) and see if it the format it is expected or not. If not, close the InternetHandler. The other thing is that it would set some options and from what I checked, it will try to open as much as http connections as it can (using the option parameter that was passed to this function, "0x49" and "0x4a").



![](https://i.imgur.com/1o37ChE.png)



In the next step it would Initializes http requests and somehow in somewhere tries to write into a file on the internet. My guess is that it would do something and then in return send something for the hacker to let them know what it did.




![](https://i.imgur.com/7pHpZpP.png)




In this section analysing the "WININET.DLL" finished.

First we can see that it is creating a process:



    
![](https://i.imgur.com/54OWcvx.png)




There are some other functions from this library that were called:




![](https://i.imgur.com/jx8YEyR.png)




Also from the functions in this library, the "USER32.DLL" is loaded and I guess it is used to interact with user like creating a window and etc.




![](https://i.imgur.com/Zxt6Twr.png)
    



Next interesting part is "Cryption part" that is called from "ADVAPI32.DLL":

The CryptImportKey function transfers a cryptographic key from a key BLOB into a cryptographic service provider (CSP)




![](https://i.imgur.com/wl2CnG9.png)




There is a list of functions that are working together to do this encryption : 




![](https://i.imgur.com/xRbnJyL.png)




In the strings, we can see the list below that I think is the file types that this malware will go through and try to encrypt:




![](https://i.imgur.com/rJqKS1S.png)




There was "HTTP" string and I searched for it and turn to this amazing part:




![](https://i.imgur.com/LuYcpa2.png)




I guess it will request for this sort of file "main.php" 


The other application I used and we can gain some good informations about the gui of this malware:


    

![](https://i.imgur.com/SubT05H.png)




-----------
2. Now try to use other online tools (for example, any.run, hybrid analysis, ...), upload the malware and see what artifact it detects.



### Implementation:

I sent the file through "any.run" and this is the result:

- any.run

![](https://i.imgur.com/OSXfRfy.png)
    
![](https://i.imgur.com/GYqra4Z.png)

![](https://i.imgur.com/dv2ag38.png)

![](https://i.imgur.com/ou4IRhe.png)

![](https://i.imgur.com/8yK41M2.png)    
    





-----------------
3. Compare the findings of both methods, and see if there are some artifacts that online tools did not manage to find, or vice versa. For example, a piece of code or information that helps you in your analysis.



### Implementation:

Actually what ever the online tool found, I could find myself but it took time and it was not this clear :)) 
And if I could put more time analysing the code, I guess I was able to find more. But totally when we face kinda zero-day malware, there is no much rules, and investigations on the online tools thats why we can not rely on them and we do the analysing ourselves.


In this case, we both find that it is creating the http requests to that ip address and asking for "main.php" file. 
I didn't find the exact name of the registration key values and I only understood that it was doing some reg reading a writing.

---------------------
4. Try to describe which method is better (Sandboxing V.S. Static analysis) is better, and which one is more useful in which case.


### Implementation:


There is no better or worst, only time and resources that we have is the matter.
I think if we are able to do the static analyisis first, we can understand what we are going to face and then using the sandboxing, we can understand better. We can see what we had some guess about it.

sandboxing or dynamic analysis is more sophisticated and dangerous.
While static analysis works for the common malware, dynamic analysis, being behavior-based, is needed for the more sophisticated and advanced kind of malware.

## Task 4: Mapping to ATT&CK mitre framework

Map the malware that you have selected to the ATT&CK MATRIX, use this LINK. you can take some examples from HERE and HERE.




![](https://i.imgur.com/EuYhHwH.png)

